<!doctype html>
<html>
<header>
  <title>LED Controller</title>
  <style>
    body {
      background-color: #f0f0f0;
      color: rgb(0, 0, 119);
      font-family: Arial, Helvetica, sans-serif;
    }

    a {
      padding: 1em;
      border: 1px solid gray;
      color: gray;
      font-weight: bold;
      border-radius: .2em;
    }

    a:hover {
      background-color: silver;
      color: rgb(0, 0, 119);
    }

    a:active {
      border: 2px solid red;
      background-color: rgb(241, 122, 122);
      color: rgb(0, 0, 119);
    }

    div.complete {
      margin: 0;
      position: absolute;
      top: 50%;
      width: 100%;
      -ms-transform: translateY(-50%);
      transform: translateY(-50%);
    }

    div.workarea,
    div.linkarea {
      margin-top: 1em;
      text-align: center;
    }

    div.linkarea {
      margin-top: 2.5em;
    }

    /* switche */
    .switch {
      position: relative;
      display: inline-block;
      width: 85%;
      min-width: 1em;
      height: 3em;
      margin-bottom: 1em;
      margin-left: 1%;
      margin-right: 1%;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      border-radius: .2em;
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 2.3em;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: rgb(0, 56, 240);
      -webkit-transition: .4s;
      transition: .4s;
    }


    input:checked+.slider {
      background-color: #6db466;
    }

    input:focus+.slider {
      box-shadow: 0 0 1px #21f33d;
    }

    input:checked+.slider:before {
      -webkit-transform: translateX(26px);
      -ms-transform: translateX(26px);
      transform: translateX(26px);
    }

    /*color picker*/
    input.color_picker {
      border-radius: .2em;
      width: 45%;
      height: 5em;
      padding: .6em;
    }

    label.color_picker {
      font-weight: bold;
    }


    /*kleine Displays*/
    @media all and (max-width: 75em) {
      a {
        padding: 2em;
        font-weight: bold;
        border-radius: .4em;
      }

      div.workarea {
        margin-top: 2.6em;
      }

      div.linkarea {
        margin-top: 5em;
        font-size: 2em
      }

      .switch {
        width: 85%;
        min-width: 1em;
        height: 9em;
        margin-bottom: 1em;
        margin-left: 1%;
        margin-right: 1%;
      }

      .slider {
        border-radius: .4em;
      }

      .slider:before {
        height: 8.4em;
      }

      /*color picker*/
      input.color_picker {
        border-radius: .4em;
        width: 75%;
        height: 10em;
        padding: .6em;

      }

      label.color_picker {
        font-size: 4em
      }

    }

    /* switche ende*/
  </style>
  <script>
    var lastChange = 10;
    var busyLock = 10;
    var busyLockStart = 30;

    function init_page() {
      var elem = document.getElementById('led_standby_checkbox');
      if (elem) {
        elem.onclick = function () { setStandby(!this.checked) };
      }
      elem = document.getElementById("color_picker");
      if (elem) {
        elem.addEventListener("input", colorInput, false);
        elem.addEventListener("change", colorChange, false);
      }
      setInterval(function () {
        if (lastChange > 0) { lastChange-- };
        if (busyLock > 0) { busyLock-- };
      }, 500);
    }

    function colorChange(elem) {
      console.debug("color entry change");
      lastChange = 0;
      busyLock = 0;
      colorInput(elem);
      document.getElementById("color_picker_area").style.backgroundColor = /*"#f0f0f0";*/ "initial";
    }

    function colorInput(elem) {
      var theColor = elem.target.value;
      console.debug("color entry input: " + theColor);
      document.getElementById("color_picker_area").style.backgroundColor = theColor;
      // nur alle 0.5 Sekunden zulassen
      if (lastChange > 0 || busyLock > 0) {
        return;
      }
      lastChange = 1;
      /*hex string to int*/
      var rgbColor = parseInt(theColor.substring(1), 16);
      /* convert int to rgbw */
      var hsv = rgb2hsv(rgbColor);
      var rgbw = hsv2rgbw(hsv);
      /*values store in percent*/
      red_val = (rgbw[0] * 100.0) / 255.0;
      green_val = (rgbw[1] * 100.0) / 255.0;
      blue_val = (rgbw[2] * 100.0) / 255.0;
      white_val = (rgbw[3] * 100.0) / 255.0;
      /* set in percent to MC */
      console.debug("rgbw color: " + red_val.toFixed(2) + ", " + green_val.toFixed(2) + ", " + blue_val.toFixed(2) + ", " + white_val.toFixed(2));
      set_rgbw(red_val.toFixed(2), green_val.toFixed(2), blue_val.toFixed(2), white_val.toFixed(2))
    }

    function rgb2hsv(rgb) {

      let R, G, B, H, S, V;

      R = (rgb >> 16) & 0xFF;
      G = (rgb >> 8) & 0xFF;
      B = rgb & 0xFF;

      const M = Math.max(R, G, B);
      const m = Math.min(R, G, B);

      V = M / 255; //range to [0, 1]
      S = M === 0 ? 0 : (1 - m / M);

      const num = R - 0.5 * G - 0.5 * B;
      const den = Math.sqrt(Math.pow(R, 2) + Math.pow(G, 2) + Math.pow(B, 2) - R * G - R * B - G * B);
      let div;
      if (den === 0) {
        div = 0;
      } else {
        div = num / den;
      }
      const count = Math.acos(div) / Math.PI * 180;
      if (G >= B) {
        H = count;
      } else {
        H = 360 - count;
      }

      return [H, S, V]
    };

    function hsv2rgb(hsv) {

      let R, G, B;

      let H = hsv[0];
      let S = hsv[1];
      let V = hsv[2];

      if (H === 0) {
        R = V + 2 * V * S;
        G = V - V * S;
        B = V - V * S;
      } else if (0 < H < 120) {
        R = V + V * S * Math.cos(H) / Math.cos(60 - H);
        G = V + V * S * (1 - Math.cos(H) / Math.cos(60 - H));
        B = V - V * S;
      } else if (H === 120) {
        R = V - V * S;
        G = V + 2 * V * S;
        B = V - V * S;
      } else if (120 < H < 240) {
        R = V - V * S;
        G = V + V * S * Math.cos(H - 120) / Math.cos(180 - H);
        B = V + V * S * (1 - Math.cos(H - 120) / Math.cos(180 - H));
      } else if (H === 240) {
        R = V - V * S;
        G = V - V * S;
        B = V + 2 * V * S;
      } else {
        R = V + V * S * (1 - Math.cos(H - 240) / Math.cos(300 - H));
        G = V - V * S;
        B = V + V * S * Math.cos(H - 240) / Math.cos(300 - H);
      }

      return [R, G, B]
    };

    function hsv2rgbw(hsv) {
      let r, g, b, w;
      let cos_h, cos_1047_h;

      let H = hsv[0];
      let S = hsv[1];
      let V = hsv[2];

      H = 3.14159 * H / 180; // Convert to radians.
      S = S > 0 ? (S < 1 ? S : 1) : 0; // clamp S and I to interval [0,1]
      V = V > 0 ? (V < 1 ? V : 1) : 0;

      if (H < 2.09439) {
        cos_h = Math.cos(H);
        cos_1047_h = Math.cos(1.047196667 - H);
        r = S * 255 * V / 3 * (1 + cos_h / cos_1047_h);
        g = S * 255 * V / 3 * (1 + (1 - cos_h / cos_1047_h));
        b = 0;
        w = 255 * (1 - S) * V;
      } else if (H < 4.188787) {
        H = H - 2.09439;
        cos_h = Math.cos(H);
        cos_1047_h = Math.cos(1.047196667 - H);
        g = S * 255 * V / 3 * (1 + cos_h / cos_1047_h);
        b = S * 255 * V / 3 * (1 + (1 - cos_h / cos_1047_h));
        r = 0;
        w = 255 * (1 - S) * V;
      } else {
        H = H - 4.188787;
        cos_h = Math.cos(H);
        cos_1047_h = Math.cos(1.047196667 - H);
        b = S * 255 * V / 3 * (1 + cos_h / cos_1047_h);
        r = S * 255 * V / 3 * (1 + (1 - cos_h / cos_1047_h));
        g = 0;
        w = 255 * (1 - S) * V;
      }

      return [r, g, b, w]
    };

    function toNum(arr) {
      let length = arr.length;
      let result = 0;
      arr.forEach((item, index) => {
        result += Math.round(item) * Math.pow(2, (length - 1 - index) * 8);
      });
      return result;
    };

    function setStandby(is_stb) {
      var xhr = new XMLHttpRequest();
      var url = '/rest/led';
      var stb = 'true';
      if (is_stb == false) {
        stb = 'false';
      }
      xhr.open('POST', url, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var json = JSON.parse(xhr.responseText);
          console.log('standby:' + json.standby + ', error:' + json.error);
        }
      };
      var data = JSON.stringify({ 'set_standby': stb });
      console.debug(data);
      xhr.send(data);
    }

    function set_rgbw(r, g, b, w) {
      busyLock = busyLockStart;

      var xhr = new XMLHttpRequest();
      var url = '/rest/led';
      xhr.open('POST', url, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          var json = JSON.parse(xhr.responseText);
          console.log('response from controller:' + json.set_rgbw);
          busyLock = 0;
        }
      };
      var data = JSON.stringify({ 'set_rgbw': { "red": r, "green": g, "blue": b, "white": w } });
      console.debug(data);
      xhr.send(data);
    }
  </script>
</header>

<body onload="init_page()" id="color_picker_area">
  <div class="complete">
    <div class="workarea">
      <label class="color_picker" for="led_standby_checkbox">LED STANDBY</label>
      <br />
      <label class="switch">
        <input type="checkbox" id="led_standby_checkbox" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div class="workarea">
      <label class="color_picker" for="color_picker">LED COLOR</label>
      <br />
      <input class="color_picker" type="color" id="color_picker" name="color_picker" value="#b0b0b0">
    </div>
    <div class="linkarea">
      <a href="/rest/config" target="_self">[ CONTROLLER CONFIG ]</a>
    </div>
  </div>
</body>

</html>